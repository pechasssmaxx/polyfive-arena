# External Integrations

**Analysis Date:** 2026-02-23

## APIs & External Services

**Polymarket CLOB (Central Limit Order Book):**
- Service: Polymarket crypto prediction market trading API
- What it's used for: Place and manage conditional token orders for all 5 bot accounts
- SDK/Client: `@polymarket/clob-client` v5.2.4
- Auth: API key + secret + passphrase (per-bot credentials)
  - Environment vars: `BOT_1_CLOB_API_KEY`, `BOT_1_CLOB_SECRET`, `BOT_1_CLOB_PASSPHRASE` (and BOT_2 through BOT_5)
  - Fallback legacy vars: `CLOB_API_KEY`, `CLOB_SECRET`, `CLOB_PASSPHRASE` (for BOT_1 compatibility)
- Implementation: `server/services/realTrader.ts` - Initializes 5 separate `ClobClient` instances (one per bot wallet)
- Host: `https://clob.polymarket.com` (production)
- Chain ID: 137 (Polygon mainnet)

**Polymarket Real-Time Data (WebSocket):**
- Service: Polymarket market data streaming API
- What it's used for: Monitor donor wallet trades in real-time via WebSocket
- SDK/Client: `@polymarket/real-time-data-client` v1.4.0
- Implementation: `server/services/copyTrader.ts` - Subscribes to `/ws` endpoint for trade events
- Endpoint: `ws://ws-live-data.polymarket.com`
- Proxy bypass: Listed in `GLOBAL_AGENT_NO_PROXY` to skip proxy routing

**Polymarket Gamma API:**
- Service: Polymarket market metadata and lookup service
- What it's used for: Reverse-lookup tokenId → market condition and outcome index
- Implementation: `server/services/onChainListener.ts` - Calls `https://gamma-api.polymarket.com/markets?clob_token_ids={tokenId}`
- Response: Market metadata including conditionId and clobTokenIds array
- Timeout: 6 seconds per request
- Cache: Caches results for 1 hour (TTL 60 mins)

**Polymarket Data API:**
- Service: Polymarket market data and polling fallback
- What it's used for: Periodic polling backup if WebSocket is unavailable (3s interval fallback)
- Endpoint: `https://data-api.polymarket.com`
- Proxy bypass: Listed in `GLOBAL_AGENT_NO_PROXY`

**Polygon Alchemy RPC (WebSocket):**
- Service: Polygon blockchain RPC provider
- What it's used for: Monitor on-chain OrderFilled events from Polymarket exchange contracts (faster than API polling)
- Connection type: WebSocket (secure, persistent)
- Environment var: `POLYGON_WSS_URL`
- Config format: `wss://polygon-mainnet.g.alchemy.com/v2/{KEY}`
- Dashboard: https://dashboard.alchemy.com
- Implementation: `server/services/onChainListener.ts` - Subscribes to CTF Exchange and NegRisk Exchange contracts
- Contracts monitored:
  - CTF Exchange: `0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E`
  - NegRisk Exchange: `0xC5d563A36AE78145C45a50134d48A1215220f80a`
- Events: `OrderFilled(orderHash, maker, taker, makerAssetId, takerAssetId, makerAmountFilled, takerAmountFilled, fee)`

**Binance API:**
- Service: Crypto price data (used for dashboard display only, not trading)
- What it's used for: Fetch 24-hour price data for BTC, ETH, SOL, XRP
- Endpoint: `https://api.binance.com/api/v3/ticker/24hr`
- Implementation: `server/index.ts` - `/api/prices` endpoint (lines 84-112)
- Fallback: Returns static prices if API fails (BTC=$95k, ETH=$2.7k, SOL=$140, XRP=$2.2)
- Proxy bypass: Listed in `GLOBAL_AGENT_NO_PROXY`

## Data Storage

**Databases:**

SQLite (better-sqlite3):
- Location: `data/polyfive_copycat.db` (created at runtime if missing)
- Path config: `server/models/db.ts` - Creates `data/` directory if missing
- Connection: Synchronous via `better-sqlite3` driver
- Pragmas: WAL mode enabled (`journal_mode = WAL`, `synchronous = NORMAL`)
- Schema: Three core tables
  - `trades` - Trade execution records (id, agentId, direction, entryPrice, exitPrice, pnl, status, timestamps, etc.)
  - `balances` - Historical equity snapshots (timestamp, per-bot balance columns: claude, chatgpt, gemini, grok, deepseek)
  - `agent_stats` - Aggregated agent performance (balance, totalPnl, totalRoi, winrate, totalTrades, wins, losses)
- Backfill: Automatically migrates old records with missing conditionId/outcomeIndex from trade ID parsing
- Initialization: `server/models/db.ts` - `initializeAgents()` seeds all 5 bot records

**File Storage:**
- Public static files: `public/` directory (fonts)
- Built frontend assets: `dist/` directory (generated by `npm run build`)
- Configuration files: Root directory (`.env`, config JSON files)

**Caching:**
- Token ID cache: In-memory map in `realTrader.ts` - Caches market token IDs for 1 hour (avoids repeated getMarket calls)
- Token-to-market cache: In-memory map in `onChainListener.ts` - Caches tokenId → conditionId/outcomeIndex lookups for 1 hour
- React Query cache: Frontend-side via `@tanstack/react-query` - Caches API responses with default stale time

## Authentication & Identity

**Auth Provider:**
- Custom (no third-party auth provider)

**Implementation:**
- Bot identity: Environment variable-based (5 separate `BOT_X_PKEY` private keys)
- Signature type: Wallet signature vs. Proxy Safe signature (determined by checking `BOT_X_FUNDER` format)
- CLOB API auth: API key + secret + passphrase (stateless, passed per request)
- Admin endpoints: Protected by `ADMIN_PASSWORD` header check (e.g., `/api/admin/clear-data`)
- On-chain signing: ethers.js `Wallet` class signs CLOB orders with `BOT_X_PKEY`

**Wallet Management:**
- Primary signer wallet: `BOT_X_PKEY` (EOA private key, signs trades)
- Funder/proxy wallet: `BOT_X_FUNDER` (shown on Polymarket profile, used for CLOB API identity)

## Monitoring & Observability

**Error Tracking:**
- Not detected - No Sentry, Rollbar, or similar integration

**Logs:**
- Approach: Console logging (`console.log`, `console.error`, `console.warn`)
- Pattern: Prefixed log messages
  - `[RealTrader]` - Order execution logs
  - `[OnChain]` - Blockchain event detection
  - `[CopyTrader]` - WebSocket trade monitoring
  - `[DB]` - Database operations
  - `[SSE]` - Server-sent events
  - `[Proxy]` - HTTP proxy status
  - `[SERVER]` - Server startup/shutdown
  - `[CRASH GUARD]` - Unhandled rejections and exceptions
- No persistent log storage configured

**Process Monitoring:**
- Crash guard: `server/index.ts` (lines 21-27) - Catches unhandledRejection and uncaughtException events
- Graceful shutdown: SIGINT handler closes server cleanly on Ctrl+C

## CI/CD & Deployment

**Hosting:**
- Deployment target: Any Node.js-capable server/container
- Static frontend: Served from Express static middleware (`app.use(express.static(distPath))`)
- Production build: Single Express server on port 3001 (both frontend + API)

**CI Pipeline:**
- Not detected - No GitHub Actions, GitLab CI, or similar config in repo
- Manual deployment model expected

**Build Process:**
- Frontend: `npm run build` → Vite builds to `dist/` directory
- Backend: No build step (tsx executes TypeScript directly)
- Production startup: `npm run server` (starts Express on port 3001, serves `dist/index.html` for all unknown routes)

## Environment Configuration

**Required env vars:**

Critical for operation:
- `SIMULATION_MODE` - `true` = no real orders, `false` = live trading (no validation, defaults to false)
- `PORT` - Server port (defaults to 3001)
- `ADMIN_PASSWORD` - Password for `/api/admin/clear-data` endpoint
- `BOT_X_PKEY` (X=1..5) - EOA private key (0x-prefixed hex string)
- `BOT_X_FUNDER` (X=1..5) - Funder/proxy wallet address (optional, 0x-prefixed hex string)
- `BOT_X_CLOB_API_KEY` (X=1..5) - Polymarket CLOB API key
- `BOT_X_CLOB_SECRET` (X=1..5) - Polymarket CLOB API secret
- `BOT_X_CLOB_PASSPHRASE` (X=1..5) - Polymarket CLOB API passphrase
- `POLYGON_WSS_URL` - Alchemy Polygon WebSocket URL (wss://...)
- `CLOB_API_KEY`, `CLOB_SECRET`, `CLOB_PASSPHRASE` - Legacy BOT_1 aliases (for backwards compatibility)

Optional:
- `GLOBAL_AGENT_HTTP_PROXY` - HTTP proxy URL (format: `http://user:password@host:port`)
- `GLOBAL_AGENT_NO_PROXY` - Comma-separated hosts to bypass proxy (predefined defaults include Polymarket & Binance hosts)
- `OPENROUTER_API_KEY` - For AI decision logic integration (not currently used in core flow)

**Secrets location:**
- `.env` file (git-ignored, created from `.env.example`)
- Not stored in repo; must be set per-deployment environment
- No dedicated secrets management (e.g., HashiCorp Vault, AWS Secrets Manager)

## Webhooks & Callbacks

**Incoming:**
- None detected - No external webhooks consumed by the application

**Outgoing:**
- Not applicable - Application does not emit webhooks to external services

**Internal Real-Time:**
- Server-Sent Events (SSE): Frontend subscribes to `GET /api/events` for instant trade notifications
- Payloads: `trade:open`, `trade:close`, `stats:update` events
- Implementation: `server/sse.ts` - Maintains set of open client connections, broadcasts events to all

---

*Integration audit: 2026-02-23*
